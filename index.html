<html>
<head>
	<title>FreeFlow game</title>
	<script type="text/javascript" src="js/angular.min.js"></script>
	<script type="text/javascript">
	var GameApplication = angular.module('GameApp', []);
	
	GameApplication.controller("InitController", function($scope, $sce){
		$scope.isUserTableReady = 0;
		$scope.isColorDotsReady = 0;
		
		$scope.colorBoxes = ['red', 'yellow', 'blue'];
		//Mouse operation
		$scope.isPressed = 0;	
		$scope.firstCellBkColor = "";
		$scope.pathTraversed = [];
		$scope.prevBkColor = "";
		$scope.defaultBkColor = "white";
		$scope.userPlayAreaContent = '';	//not used
		$scope.myDim = 0;
		$scope.currentOverallCellValue = 0;
		$scope.currentMatchReport = [];
		
		$scope.convasdimension = [			  
			  {name:'3x3', id:3},
			  {name:'4x4', id:4},
			  {name:'5x5', id:5},		  
		];
						
		$scope.colorDotLocations = [
		  [
			["red", 1, 6, 11, 16, 21, 22, 77],
			["green", 3, 2, 7, 12, 17, 41],
			["yellow", 5, 4, 9, 14, 19, 51],
			["blue", 8, 13, 18, 23, 62],
			["orange", 10, 15, 20, 25, 24, 94]
		  ],
		  [
			["red", 1, 2, 3, 4, 5, 10, 15, 20],
			["blue", 16, 11, 6, 7, 8, 9, 14, 19, 24, 25],
			["green", 17, 12, 13],
			["yellow", 21, 22, 23, 18]
		  ],
		  [
			["yellow", 2, 1, 6, 11, 16],
			["blue", 3, 8, 7, 12, 17, 22, 21],
			["green", 4, 5, 10, 15, 20, 25, 24],
			["red", 9, 14, 13],
			["orange", 19, 18, 23]
		  ]
		];
		
		$scope.drawColoredDots = function(){			
			//if table drawn completed then only start putting the dots.
			if($scope.isUserTableReady){
				console.log('D1 : drawing color dots started');
				var j, cellColor, randomGameNumber, innerLen, innerMostLen, cellID, tempElem, len = ($scope.colorDotLocations).length;				
				randomGameNumber = 0;
				
				innerLen = $scope.colorDotLocations[randomGameNumber].length;
				for(j=0;j<innerLen;j++){						
					//Find out color for first & last cell
					innerMostLen = ($scope.colorDotLocations[randomGameNumber][j]).length;
					cellColor = $scope.colorDotLocations[randomGameNumber][j][0];
																
					cellID = "#d"+($scope.myDim)+"cell_"+$scope.colorDotLocations[randomGameNumber][j][1];							
					tempElem = angular.element(document.querySelector(cellID));
					tempElem.addClass(cellColor);											
					cellID = "#d"+($scope.myDim)+"cell_"+$scope.colorDotLocations[randomGameNumber][j][innerMostLen-2];																																						
					tempElem = angular.element(document.querySelector(cellID));
					tempElem.addClass(cellColor);
					//It will help to check the match
					tempElem.attr('result', $scope.colorDotLocations[randomGameNumber][j][innerMostLen-1]);						
				}
			
				$scope.isColorDotsReady = 1;	
			}
		}	
		
		/* It will used in case of undo the user selection */
		$scope.rollBackCellColor = function(){
			var i, cellID, tempElem, len = ($scope.pathTraversed).length;
			for(i=1;i<len;i++){							
				cellID = "#" + $scope.pathTraversed[i];																				
				tempElem = angular.element(document.querySelector(cellID));
				tempElem.removeClass($scope.firstCellBkColor);
			}			
		};
		
		/* Draw the user play convas */	  			  
		$scope.drawTable = function(){			
			var divs = '', counter = 1, i, j, dim;
			dim = $scope.myDim;			
									
			for(i=0;i<dim;i++){
				divs += '<div class="row">'
				for(j=0;j<dim;j++){
					divs += '<div class="cell" id="cell'+(counter++)+'"></div>';
				}					
				divs += '</div>';	
			}	
			
			$scope.userPlayAreaContent = $sce.trustAsHtml(divs);				
			$scope.isUserTableReady = 1;						
			console.log('Table drawing activity completed.');
		}			
	});
		
	GameApplication.directive('cell', function() {
		  return {
			restrict: 'C',			
			link: function(scope, elem, attrs) {
			  	  
			  elem.on('mousedown', function() {
				//Basic initialization	
				scope.isPressed = 1; 	
				scope.pathTraversed = [];
				scope.overallCellValue = 0;			
				
				var classNames = (elem.attr('class')).split(" ");
				scope.firstCellBkColor = classNames[1];			
				(scope.pathTraversed).push(attrs.id);
				//adding the cell value to calculate the match value.
				var cellValue = (attrs.id).split("_");
				scope.currentOverallCellValue += parseInt(cellValue[1]);
				console.log('Starting point is '+attrs.id + ' & cell value: '+scope.currentOverallCellValue);			
			  });
			  
			  elem.bind('mouseover', function() {
				if(scope.isPressed){
					//Finding the current startCellBkColor & assigning it to global varible called prevBkColor
					var classNames = (elem.attr('class')).split(" ");					
					if(classNames.length == 1 && classNames[0] == "cell"){						
						scope.prevBkColor = classNames[1] = "white";	
					}else{						
						scope.prevBkColor = classNames[1];													
					}				
					
					//Check - if current startCellBkColor is different from startCellBkColor or white means its trying to overlap & we need to stop it & try to rollback the cells
					if(scope.prevBkColor != scope.defaultBkColor && scope.prevBkColor != scope.firstCellBkColor){
						console.log('Colored cell overlapping issue - terminating it');
						scope.rollBackCellColor();
						scope.isPressed = 0;					
						return;
					}	
					//Assigning the back ground color
					elem.addClass(scope.firstCellBkColor);	
					(scope.pathTraversed).push(attrs.id);	
					//adding the cell value to calculate the match value.
					var cellValue = (attrs.id).split("_");
					scope.currentOverallCellValue += parseInt(cellValue[1]);	
					console.log('cell value: '+scope.currentOverallCellValue);						
				}				
			  });
			  
			  elem.bind('mouseup', function(){
				if(scope.isPressed){
					var i=0, 
						cellID,	tempElem, classNames, 
						len = (scope.pathTraversed).length;
					scope.isPressed = 0;					
					classNames = (elem.attr('class')).split(" ");
					//console.log('First cell BkColor: '+scope.firstCellBkColor+ ' & current cell bkcolor : ' + classNames[1] + ' & prev Bkcolor:' + scope.prevBkColor);
					if(scope.firstCellBkColor != classNames[1]){						
						len--;
						for(i=1;i<len;i++){							
							cellID = "#" + scope.pathTraversed[i];																				
							tempElem = angular.element(document.querySelector(cellID));
							tempElem.removeClass(scope.firstCellBkColor);
						}
						console.log('d1: '+ scope.pathTraversed);						
					}else{
						//If user release the mouse button in between
						if(scope.prevBkColor == scope.defaultBkColor){
							for(i=1;i<len;i++){							
								cellID = "#" + scope.pathTraversed[i];																				
								tempElem = angular.element(document.querySelector(cellID));
								tempElem.removeClass(scope.firstCellBkColor);
							}
							console.log('d2: ' + scope.pathTraversed);	
						}
					}									
					//Check whether its matching with the cell value
					if(attrs.result == scope.currentOverallCellValue){
						(scope.currentMatchReport).push(scope.firstCellBkColor);		
					}					
					console.log('End point is '+attrs.id + ' & match array : ' + scope.currentMatchReport);					
				}				
			  });
			}
		  };
	});
	</script>
	<style>
		.cell{height: 100px; width: 100px; border: red 1px solid;float: left;}
		.red {background-color: red;}
		.yellow {background-color: yellow;}
		.blue {background-color: blue;}
		.green {background-color: green;}
		.orange {background-color: orange;}
		.row {clear: both;}
	</style>
</head>
<body>
<div ng-app='GameApp' ng-controller="InitController">
	Select the User convas dimension :
	<select ng-model="myDim">
		<option ng-repeat="dimension in convasdimension" value="{{dimension.id}}">{{dimension.name}}</option>
	</select>
	<input ng-show="isUserTableReady" type="button" ng-click="drawColoredDots()" value="Populate the dots" />	
	<user-convas-area ng-show="myDim == 5" ng-init="isUserTableReady=1">
		<div class="row">
			<div class="cell" id="d5cell_1"></div>
			<div class="cell" id="d5cell_2"></div>
			<div class="cell" id="d5cell_3"></div>
			<div class="cell" id="d5cell_4"></div>
			<div class="cell" id="d5cell_5"></div>
		</div>
		<div class="row">
			<div class="cell" id="d5cell_6"></div>
			<div class="cell" id="d5cell_7"></div>
			<div class="cell" id="d5cell_8"></div>
			<div class="cell" id="d5cell_9"></div>
			<div class="cell" id="d5cell_10"></div>
		</div>
		<div class="row">
			<div class="cell" id="d5cell_11"></div>
			<div class="cell" id="d5cell_12"></div>
			<div class="cell" id="d5cell_13"></div>
			<div class="cell" id="d5cell_14"></div>
			<div class="cell" id="d5cell_15"></div>
		</div>
		<div class="row">
			<div class="cell" id="d5cell_16"></div>
			<div class="cell" id="d5cell_17"></div>
			<div class="cell" id="d5cell_18"></div>
			<div class="cell" id="d5cell_19"></div>
			<div class="cell" id="d5cell_20"></div>
		</div>
		<div class="row">
			<div class="cell" id="d5cell_21"></div>
			<div class="cell" id="d5cell_22"></div>
			<div class="cell" id="d5cell_23"></div>
			<div class="cell" id="d5cell_24"></div>
			<div class="cell" id="d5cell_25"></div>
		</div>
	</user-convas-area>
	
</div>
</body>
</html>
